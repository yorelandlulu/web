<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.kun.flow.data.RoleBindPermitMapper">
    <resultMap id="BaseResultMap" type="com.kun.flow.model.NewsCategory">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Aug 08 15:55:10 CST 2014.
        -->
        <id column="id" jdbcType="BIGINT" property="id" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="status" jdbcType="INTEGER" property="status" />
        <result column="parentid" jdbcType="BIGINT" property="parentid" />
    </resultMap>
	<resultMap id="RoleBindPermitResultMap" type="com.kun.flow.model.RoleBindPermit">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. This element 
			was generated on Thu Apr 24 23:56:12 CST 2014. -->
		<id column="id" property="id" jdbcType="BIGINT" />
		<!-- <result column="permitId" property="permitId" jdbcType="BIGINT" /> -->
		<!-- <result column="roleId" property="roleId" jdbcType="BIGINT" /> -->
		<result column="createTime" property="createTime" jdbcType="TIMESTAMP" />
		<result column="updateTime" property="updateTime" jdbcType="TIMESTAMP" />
		<result column="operaterId" property="operaterId" jdbcType="BIGINT" />
		<result column="categoryid" property="categoryid" jdbcType="BIGINT" />
		<result column="operaterCode" property="operaterCode" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="auditable" property="auditable" jdbcType="BIT" />
		<result column="editable" property="editable" jdbcType="BIT" />
		<association property="permit" column="permitId" javaType="com.kun.flow.model.NewsCategory">
			<id property="id" column="permitId" />
			<result property="name" column="permit_name" />
		</association>
		<association property="role" column="roleId" javaType="com.kun.flow.model.Role">
			<id property="id" column="roleId" />
			<result property="name" column="role_name" />
		</association>
	</resultMap>
	<!-- ======================================================== -->
	<!-- hibernate-oracle分页的处理方式 -->
	<!-- select * from ( select row_.*, rownum rownum_ from ( select * from table ) row_ where rownum <= ? ) where rownum_ > 
		? -->
	<sql id="RoleBindPermit_Columns">
		rbp.categoryid as categoryid, rbp.editable as editable, rbp.auditable as auditable, rbp.id, rbp.permitId, rbp.roleId, rbp.createTime, rbp.updateTime, rbp.operaterId, rbp.operaterCode,
		rbp.status,ca.name as
		permit_name, r.name as role_name
	</sql>
	<!-- 增加 -->
	<insert id="save" parameterType="com.kun.flow.model.RoleBindPermit" useGeneratedKeys="true" keyProperty="object.id">
		insert into role_bind_permit (permitId, roleId, createTime,
		operaterId, operaterCode, status, categoryid, editable)
		values
		(#{object.permitId,jdbcType=BIGINT}, #{object.roleId,jdbcType=BIGINT}, #{object.createTime,jdbcType=TIMESTAMP}, #{object.operaterId,jdbcType=BIGINT},
		#{object.operaterCode,jdbcType=VARCHAR}, #{object.status,jdbcType=BIGINT}, #{object.categoryid,jdbcType=BIGINT}, 1)
	</insert>
	<!-- 修改 -->
	<update id="update" parameterType="com.kun.flow.model.RoleBindPermit">
	</update>
	<!-- 删除 -->
	<select id="deleteByRole" resultMap="RoleBindPermitResultMap" parameterType="java.io.Serializable">
		delete from role_bind_permit where
		roleId=#{key}
	</select>
	<delete id="delete" parameterType="com.kun.flow.model.RoleBindPermit">
	</delete>
	<delete id="deleteAll">
	</delete>
	<delete id="deleteByKey" parameterType="java.io.Serializable">
	</delete>
	<!-- 查询 -->
	<select id="getByKey" resultMap="RoleBindPermitResultMap" parameterType="java.io.Serializable">
	</select>
	<select id="getOneByNameOrCode" resultMap="RoleBindPermitResultMap" parameterType="com.kun.flow.model.Operater">
	</select>
	<select id="findByExample" resultMap="RoleBindPermitResultMap" parameterType="com.kun.flow.model.Operater">
	</select>
	<select id="findOnePageByExample" resultMap="RoleBindPermitResultMap" parameterType="map">
	</select>
	<select id="findOneByExample" resultMap="RoleBindPermitResultMap" parameterType="com.kun.flow.model.Operater">
	</select>
	<select id="loadAll" resultMap="RoleBindPermitResultMap" parameterType="com.kun.flow.model.Operater">
	</select>
	<select id="loadOnePage" resultMap="RoleBindPermitResultMap" parameterType="com.kun.flow.bean.Pagination">
	</select>
	<select id="listByRole" resultMap="RoleBindPermitResultMap" parameterType="map">
		select
		<include refid="RoleBindPermit_Columns" />
		from role_bind_permit rbp,news_category ca,role r
		where rbp.categoryid=ca.id and rbp.roleId=r.id and rbp.roleId=#{key}
	</select>
	<select id="listByRoleUnbind" resultMap="BaseResultMap" parameterType="map">
        select  cc.id, cc.name, cc.status, cc.parentid,cc.level, cc.sortid,
        case cc.level
        when "1" then cc.id
        when "2" then cc.parentid
        when "3" then (select x.parentid from news_category x where x.id = cc.parentid)
        end level1,
        case cc.level
        when "1" then "0"
        when "2" then cc.id
        when "3" then cc.parentid
        end level2,
        case cc.level
        when "1" then "0"
        when "2" then "0"
        when "3" then cc.id
        end level3
        from news_category cc
        where cc.id not in
        (select c.id from news_category c
        inner join role_bind_permit p on c.id = p.categoryid where p.roleId=#{paramMap.key})
        and
        (case cc.level
        when "1" then cc.id
        when "2" then cc.parentid
        when "3" then (select x.parentid from news_category x where x.id = cc.parentid)
        end ) is not null
        <if test="paramMap.keyword != null and paramMap.keyword != ''">
            <bind name="objkeyword" value="'%'+paramMap.keyword+'%'" />
            and cc.name like #{objkeyword}
        </if>
        order by level1, level2, level3
	</select>
	<select id="getCountByRole" resultType="int" parameterType="java.io.Serializable">
		select count(*) from role_bind_permit rbp where
		rbp.roleId=#{key}
	</select>
	<select id="getCount" resultType="int">
	</select>
	<select id="getCountByExample" resultType="int" parameterType="com.kun.flow.model.Permit">
	</select>
	<select id="getCountForSearch" resultType="int" parameterType="com.kun.flow.model.Permit">
	</select>
	<!-- ======================================================== -->
</mapper>